<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2002å¹´12æœˆ24æ—¥ - è·¨æ—¶ç©ºè¿æ¥ç»ˆç«¯</title>
    <style>
        /* --- æ ¸å¿ƒå­—ä½“ä¸åŸºç¡€è®¾ç½® --- */
        @font-face {
            font-family: 'PixelSimSun';
            src: local('SimSun'), local('Songti SC'), local('PMingLiU'), sans-serif;
        }

        :root {
            --win-gray: #c0c0c0;
            --win-blue: #000080;
            --win-dark-blue: #000040;
            --win-text: #000;
            --win-shadow-light: #fff;
            --win-shadow-dark: #808080;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #000;
            font-family: 'PixelSimSun', 'Courier New', monospace;
            cursor: default; user-select: none;
        }

        /* å¤å¤å…‰æ ‡ */
        .cursor-default { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="20" viewport="0 0 16 20"><path fill="white" stroke="black" d="M0,0 L0,14 L3,11 L6,16 L8,15 L5,10 L10,10 L0,0 Z"/></svg>'), auto; }
        .cursor-pointer { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="20" viewport="0 0 16 20"><path fill="white" stroke="black" d="M6,0 L6,14 M0,6 L12,6" stroke-width="2"/></svg>'), pointer; }
        
        body { @extend .cursor-default; }

        /* --- å¯åŠ¨ä¸å™äº‹å±‚ --- */
        #boot-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: #ccc; z-index: 10000;
            padding: 40px; font-family: 'Courier New', monospace;
            display: flex; flex-direction: column;
        }
        .boot-text { margin-bottom: 5px; text-shadow: 0 0 2px #fff; }
        .cursor-blink { animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* å™äº‹å¼•å¯¼å¼¹çª— */
        #intro-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); color: #0f0; z-index: 9999;
            display: none; align-items: center; justify-content: center;
            font-family: 'PixelSimSun', monospace;
        }
        .intro-box {
            border: 2px solid #0f0; padding: 30px; max-width: 600px;
            background: #001100; box-shadow: 0 0 20px #0f0;
            text-align: center; line-height: 1.8; position: relative;
        }
        .intro-box h1 { margin-top: 0; color: #fff; text-shadow: 0 0 5px #0f0; }
        .scan-line {
            width: 100%; height: 2px; background: rgba(0,255,0,0.3);
            position: absolute; top: 0; left: 0; animation: scan 3s linear infinite;
            pointer-events: none;
        }
        @keyframes scan { 0% {top:0} 100% {top:100%} }

        /* --- æ¡Œé¢ç¯å¢ƒ --- */
        #desktop {
            width: 100%; height: 100%; position: relative;
            background: 
                radial-gradient(circle at 50% 30%, rgba(100, 150, 255, 0.1) 0%, transparent 60%),
                linear-gradient(to bottom, #0a151a 0%, #000000 100%);
            display: none;
        }
        /* é›ªèŠ±ç”»å¸ƒ - å±‚çº§è°ƒæ•´ï¼Œç¡®ä¿ä¸é®æŒ¡ç‚¹å‡» */
        #snow-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; opacity: 0.8; z-index: 1; }

        /* --- å›¾æ ‡ç³»ç»Ÿ --- */
        .desktop-icon {
            width: 96px; height: 80px;
            position: absolute; z-index: 2; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            color: white; text-shadow: 1px 1px 2px black;
            font-size: 12px; cursor: pointer; padding: 5px;
            text-align: center; box-sizing: border-box;
        }
        .desktop-icon:hover .icon-overlay {
            background: rgba(0, 0, 128, 0.6);
            border: 1px dotted #fff;
            box-shadow: 0 0 5px rgba(255,255,255,0.5);
        }
        .icon-img { width: 32px; height: 32px; margin-bottom: 4px; image-rendering: pixelated; display: block; }
        .icon-overlay { 
            padding: 4px; border: 1px solid transparent; border-radius: 2px;
            display: flex; flex-direction: column; align-items: center; width: 100%;
        }
        .icon-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }

        /* --- çª—å£ç³»ç»Ÿ --- */
        .window {
            position: absolute; background: var(--win-gray);
            border: 2px solid; border-color: #fff #000 #000 #fff;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
            min-width: 200px; padding: 2px; font-size: 12px;
            z-index: 10;
        }
        .title-bar {
            background: linear-gradient(90deg, var(--win-blue), #1084d0);
            color: white; padding: 3px 4px; height: 18px;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; letter-spacing: 1px;
        }
        .title-bar.inactive { background: #808080; color: #c0c0c0; }
        .win-btn {
            width: 16px; height: 14px; background: var(--win-gray);
            border: 1px solid; border-color: #fff #000 #000 #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold; color: black; cursor: pointer;
            margin-left: 2px; font-family: sans-serif;
        }
        .win-btn:active { border-color: #000 #fff #fff #000; padding-top: 1px; padding-left: 1px; }
        .window-body { flex-grow: 1; padding: 0; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        .menu-bar { display: flex; padding: 2px 5px; border-bottom: 1px solid #808080; background: var(--win-gray); }
        .menu-item { margin-right: 12px; cursor: default; }
        .menu-item::first-letter { text-decoration: underline; }

        /* åº”ç”¨æ ·å¼ */
        .explorer-view { background: white; border: 2px inset #fff; flex-grow: 1; padding: 10px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(64px, 1fr)); gap: 15px; align-content: start; }
        .file-icon { display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; color: black; font-family: 'PixelSimSun'; }
        .file-icon:hover span { background: var(--win-blue); color: white; }

        .chat-area { background: white; border: 2px inset #fff; height: 220px; overflow-y: auto; padding: 8px; margin-bottom: 5px; font-family: 'SimSun', serif; }
        .chat-msg { margin-bottom: 8px; word-wrap: break-word; line-height: 1.5; font-size: 13px; }
        .chat-msg .time { color: #888; font-size: 11px; margin-right: 6px; font-family: 'Courier New'; }
        .chat-msg.them { color: #000080; }
        .chat-msg.me { color: #008000; }
        .chat-msg.sys { color: #888; font-style: italic; font-size: 11px; text-align: center; margin: 15px 0; border-top: 1px dashed #ccc; border-bottom: 1px dashed #ccc; }
        .chat-emoji { vertical-align: bottom; width: 18px; height: 18px; }

        /* èœ˜è››çº¸ç‰Œ */
        .card-table { background: #006000; flex-grow: 1; position: relative; overflow: hidden; cursor: default; box-shadow: inset 0 0 20px #003300; }
        .card { width: 45px; height: 65px; background: white; border-radius: 3px; position: absolute; border: 1px solid #000; display: flex; flex-direction: column; padding: 2px; font-size: 14px; font-weight: bold; user-select: none; box-shadow: 2px 2px 3px rgba(0,0,0,0.4); }
        .card.red { color: #d00; } .card.black { color: #000; }
        .card-face { flex-grow: 1; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        /* ä»»åŠ¡æ  */
        #taskbar { position: absolute; bottom: 0; left: 0; width: 100%; height: 28px; background: var(--win-gray); border-top: 2px solid #fff; display: flex; align-items: center; padding: 2px; z-index: 9000; }
        .start-btn { height: 22px; padding: 0 6px 0 4px; display: flex; align-items: center; font-weight: bold; font-style: italic; border: 2px outset #fff; background: var(--win-gray); cursor: pointer; margin-right: 5px; box-shadow: 1px 1px 0 #000; }
        .start-btn:active { border-style: inset; padding-top: 1px; padding-left: 1px; box-shadow: none; }
        .tray { margin-left: auto; border: 2px inset #fff; padding: 0 8px; height: 22px; line-height: 22px; background: #c0c0c0; font-size: 11px; display: flex; align-items: center; gap: 8px; }

        /* CRT æ»¤é•œ */
        #crt-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9990; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%); background-size: 100% 4px; }
        #scanlines { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9991; background: linear-gradient(90deg, rgba(255,0,0,0.04), rgba(0,255,0,0.02), rgba(0,0,255,0.04)); background-size: 3px 100%; mix-blend-mode: color-burn; }
        #vignette { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9992; background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.5) 100%); }

        .hidden { display: none !important; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9500; display: flex; align-items: center; justify-content: center; }
        .msg-box { background: var(--win-gray); border: 2px outset #fff; padding: 2px; width: 320px; box-shadow: 10px 10px 20px rgba(0,0,0,0.8); }
    </style>
</head>
<body>

    <!-- 1. BIOS -->
    <div id="boot-layer" onclick="bootToDisclaimer()">
        <div class="boot-text">Award Modular BIOS v4.51PG, An Energy Star Ally</div>
        <div class="boot-text">Copyright (C) 1984-2002, Award Software, Inc.</div>
        <br>
        <div class="boot-text">PENTIUM III CPU at 800MHz</div>
        <div class="boot-text">Memory Test: 262144K OK</div>
        <br>
        <div class="boot-text">Detecting Primary Master ... SEAGATE 80GB</div>
        <div class="boot-text">Detecting Primary Slave ... CD-ROM 52X</div>
        <br>
        <div class="boot-text" style="color: #ffff00; margin-top: 50px;">[ CLICK TO BOOT ]<span class="cursor-blink">_</span></div>
    </div>

    <!-- 2. Intro -->
    <div id="intro-modal">
        <div class="intro-box">
            <div class="scan-line"></div>
            <h1>[ è·¨æ—¶ç©ºè¿æ¥åè®® v2.0 ]</h1>
            <p>è¿æ¥ç›®æ ‡ï¼š2002å¹´12æœˆ24æ—¥ (å¹³è¡Œå®‡å®™)</p>
            <p>ç»ˆç«¯èº«ä»½ï¼š<span style="color:cyan;">ä¼¼æ°´æµå¹´</span> (QQ: 10293***)</p>
            <br>
            <p style="color:#fff;">ä»»åŠ¡ç®€æŠ¥ï¼š</p>
            <p>ä½ å·²æˆåŠŸç©¿è¶Šåˆ° 2002 å¹´çš„å¹³å®‰å¤œã€‚</p>
            <p>ä½ çš„å¥½å‹ <span style="color:yellow;">[å¾€äº‹éšé£]</span> ä»Šæ™šåœ¨ç½‘å§é€šå®µï¼Œä»–çœ‹èµ·æ¥å¾ˆå­¤å•ã€‚</p>
            <p>ä½ çš„ä»»åŠ¡æ˜¯ï¼šæ•´ç†ç”µè„‘ä¸­çš„ç¢ç‰‡ï¼Œåˆ¶ä½œä¸€ä¸ª <span style="color:red; font-weight:bold;">[å¹³å®‰æœ]</span> ç¤¼ç‰©å‘ç»™ä»–ï¼Œç»™ä»–ä¸€ä¸ªæƒŠå–œã€‚</p>
            <br>
            <button class="win-btn" style="width:180px; height:30px; margin-top:20px; font-size:14px;" onclick="enterDesktop()">>>> ç™»é™† QQ: ä¼¼æ°´æµå¹´ <<<</button>
        </div>
    </div>

    <!-- 3. Desktop -->
    <div id="desktop">
        <canvas id="snow-canvas"></canvas>

        <!-- Icons -->
        <div class="desktop-icon" style="top: 20px; left: 20px;" ondblclick="openWindow('computer')">
            <div class="icon-overlay"><img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><path fill='%23000080' d='M2 4h28v20H2z'/><path fill='%23008080' d='M4 6h24v16H4z'/><rect x='8' y='24' width='16' height='2' fill='%23808080'/><rect x='4' y='26' width='24' height='2' fill='%23c0c0c0'/></svg>" class="icon-img"><div class="icon-text">æˆ‘çš„ç”µè„‘</div></div>
        </div>
        <div class="desktop-icon" style="top: 120px; left: 20px;" ondblclick="openWindow('recycle')">
            <div class="icon-overlay"><img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><path fill='%23c0c0c0' stroke='%23000' d='M6 6h20v24H6z'/><path fill='%23808080' d='M4 6h24v2H4z'/><path d='M10 10v16M16 10v16M22 10v16' stroke='%23808080'/></svg>" class="icon-img"><div class="icon-text">å›æ”¶ç«™</div></div>
        </div>
        <div class="desktop-icon" style="top: 220px; left: 20px;" ondblclick="openWindow('chat')">
            <div class="icon-overlay"><img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle cx='16' cy='16' r='14' fill='%23000' stroke='%23fff' stroke-width='2'/><path d='M22 12a2 2 0 1 0 0-4 2 2 0 0 0 0 4zM10 12a2 2 0 1 0 0-4 2 2 0 0 0 0 4z' fill='%23fff'/><rect x='8' y='18' width='16' height='4' rx='2' fill='%23d00'/><rect x='22' y='6' width='8' height='8' fill='%23d00' rx='2'/><text x='24' y='12' fill='white' font-size='6'>msg</text></svg>" class="icon-img"><div class="icon-text">OICQ 2002</div></div>
        </div>
        <div class="desktop-icon" style="top: 320px; left: 20px;" ondblclick="openWindow('ciba')">
            <div class="icon-overlay"><img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect x='4' y='2' width='24' height='28' fill='%23204080' stroke='white'/><text x='8' y='22' fill='white' font-family='serif' font-size='20' font-weight='bold'>Cb</text><circle cx='22' cy='8' r='4' fill='none' stroke='%2300ffff' stroke-width='2'/><line x1='19' y1='11' x2='16' y2='14' stroke='%2300ffff' stroke-width='2'/></svg>" class="icon-img"><div class="icon-text">é‡‘å±±è¯éœ¸</div></div>
        </div>
        <div class="desktop-icon" style="top: 420px; left: 20px;" ondblclick="openWindow('sketchpad')">
            <div class="icon-overlay"><img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect x='2' y='2' width='28' height='28' fill='white' stroke='black'/><circle cx='16' cy='16' r='10' fill='none' stroke='blue'/><line x1='6' y1='26' x2='26' y2='6' stroke='red'/><rect x='4' y='4' width='4' height='4' fill='black'/></svg>" class="icon-img"><div class="icon-text">å‡ ä½•ç”»æ¿</div></div>
        </div>
        <div class="desktop-icon" style="top: 20px; left: 130px;" ondblclick="openWindow('solitaire')">
            <div class="icon-overlay"><img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect x='4' y='2' width='24' height='28' rx='2' fill='white' stroke='black'/><text x='8' y='22' font-size='18' fill='red'>â™¥</text><text x='6' y='10' font-size='8' fill='red'>A</text></svg>" class="icon-img"><div class="icon-text">èœ˜è››çº¸ç‰Œ</div></div>
        </div>
        <div class="desktop-icon" style="top: 120px; left: 130px;" ondblclick="openWindow('ttplayer')">
            <div class="icon-overlay"><img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle cx='16' cy='16' r='15' fill='%23ffd700' stroke='white'/><path d='M12 10 L24 16 L12 22 Z' fill='white' stroke='black'/><rect x='8' y='6' width='16' height='4' fill='black' opacity='0.3'/></svg>" class="icon-img"><div class="icon-text">åƒåƒé™å¬</div></div>
        </div>
        <div class="desktop-icon" style="top: 220px; left: 130px;" ondblclick="openWindow('maker')">
            <div class="icon-overlay"><img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><path d='M16 2 L16 8' stroke='%238b4513' stroke-width='2'/><path d='M16 8 Q24 2 28 10 Q32 24 16 30 Q0 24 4 10 Q8 2 16 8' fill='red' stroke='%23800000'/><path d='M16 8 Q20 4 22 8' fill='%2332cd32'/><circle cx='12' cy='12' r='2' fill='white' opacity='0.5'/></svg>" class="icon-img"><div class="icon-text">å¹³å®‰æœåˆ¶ä½œ</div></div>
        </div>

        <!-- Windows -->
        <!-- 1. My Computer -->
        <div id="win-computer" class="window hidden" style="width: 360px; height: 300px;">
            <div class="title-bar" onmousedown="startDrag(event, 'win-computer')">
                <div class="title-text">æˆ‘çš„ç”µè„‘</div><div class="win-btn" onclick="closeWindow('computer')">X</div>
            </div>
            <div class="menu-bar"><div class="menu-item">æ–‡ä»¶(F)</div><div class="menu-item">ç¼–è¾‘(E)</div><div class="menu-item">æŸ¥çœ‹(V)</div></div>
            <div class="window-body">
                <div style="padding:4px; border-bottom:1px solid #808080; background:#fff; display:flex; align-items:center;">
                    <span style="margin-right:5px; color:#666;">åœ°å€(D):</span><input type="text" value="C:\My Documents\Memories" style="flex-grow:1; border:1px solid #808080; padding:2px; font-family:'SimSun';">
                </div>
                <div class="explorer-view" id="file-list-container"></div>
            </div>
            <div style="border-top:1px solid #808080; padding:2px; color:#555; background:#c0c0c0;">3 ä¸ªå¯¹è±¡</div>
        </div>

        <!-- 2. OICQ -->
        <div id="win-chat" class="window hidden" style="width: 320px; height: 400px; left:400px; top:100px;">
            <div class="title-bar" onmousedown="startDrag(event, 'win-chat')">
                <div class="title-text">OICQ - å¾€äº‹éšé£</div><div class="win-btn" onclick="closeWindow('chat')">X</div>
            </div>
            <div class="window-body">
                <div style="background:#e0e0e0; padding:5px; border-bottom:1px solid white; display:flex; align-items:center;">
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%23444'/><circle cx='16' cy='16' r='10' fill='cyan'/></svg>" width="24" style="margin-right:8px; border:1px solid gray;"> 
                    <div style="display:flex; flex-direction:column;">
                        <span style="font-weight:bold; color:black;">ä¼¼æ°´æµå¹´</span><span style="font-size:10px; color:#555;">(10293***) | åœ¨çº¿</span>
                    </div>
                </div>
                <div class="chat-area" id="chat-box"></div>
                <div class="chat-input-area" style="padding:5px; display:flex; gap:5px; background:#e0e0e0;">
                    <input type="text" id="chat-input" disabled placeholder="è¿æ¥ä¸­..." onkeypress="handleChatKey(event)" style="flex-grow:1; border:2px inset #fff;">
                    <button onclick="sendChat()" style="width:60px; height:24px; border:2px outset #fff; background:#c0c0c0;">å‘é€</button>
                </div>
            </div>
        </div>

        <!-- 3. Maker -->
        <div id="win-maker" class="window hidden" style="width: 380px; height: 350px;">
            <div class="title-bar" onmousedown="startDrag(event, 'win-maker')">
                <div class="title-text">å¹³å®‰æœå°è£…å‘å¯¼ v1.0</div><div class="win-btn" onclick="closeWindow('maker')">X</div>
            </div>
            <div class="window-body" style="background:#d4d0c8; padding:15px; display:flex; flex-direction:column; justify-content:space-between;">
                <div id="maker-status" style="border:2px inset #fff; padding:8px; background:#fff; margin-bottom:10px; font-size:12px;">
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><circle cx='8' cy='8' r='7' fill='red'/><text x='5' y='12' fill='white' font-weight='bold'>!</text></svg>" width="12" style="vertical-align:middle">
                    <span style="color:red;">ç´ æç¼ºå¤±ï¼š</span>è¯·åœ¨[æˆ‘çš„ç”µè„‘]ä¸­å¯»æ‰¾å¹¶ä¿®å¤æŸåçš„æ–‡ä»¶ã€‚
                </div>
                <div id="maker-slots" style="display: flex; justify-content: space-around; background:#fff; border:1px solid #888; padding:10px;">
                    <div class="slot-container" style="text-align:center"><div id="slot-apple" style="width:64px; height:64px; background:#ccc; border:1px solid #888; display:flex; align-items:center; justify-content:center; margin-bottom:5px;">?</div><div>çº¢å¯Œå£«</div></div>
                    <div class="slot-container" style="text-align:center"><div id="slot-paper" style="width:64px; height:64px; background:#ccc; border:1px solid #888; display:flex; align-items:center; justify-content:center; margin-bottom:5px;">?</div><div>ç»ç’ƒçº¸</div></div>
                    <div class="slot-container" style="text-align:center"><div id="slot-ribbon" style="width:64px; height:64px; background:#ccc; border:1px solid #888; display:flex; align-items:center; justify-content:center; margin-bottom:5px;">?</div><div>é‡‘æ‹‰èŠ±</div></div>
                </div>
                <div id="final-gift-display" class="hidden" style="text-align:center; padding:15px; border:2px inset #fff; background:#fff;">
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><path d='M32 4 L32 12' stroke='brown' stroke-width='4'/><circle cx='32' cy='36' r='20' fill='red'/><rect x='12' y='36' width='40' height='4' fill='gold'/><path d='M12 36 L32 16 L52 36' fill='none' stroke='gold' stroke-width='2'/><rect x='12' y='16' width='40' height='40' fill='rgba(0,255,255,0.2)' stroke='blue' stroke-width='1'/></svg>" width="64">
                    <div style="color:blue; font-weight:bold; margin-top:5px;">Christmas_Apple.zip</div>
                </div>
                <div>
                    <button id="btn-assemble" onclick="assemble()" disabled style="width:100%; height:32px; font-weight:bold; color:#888;">ç­‰å¾…ç´ æ...</button>
                    <button id="btn-send-gift" onclick="sendGift()" class="hidden" style="width:100%; height:32px; font-weight:bold; color:black; border:2px outset #fff;">å‘é€ç»™ [å¾€äº‹éšé£]</button>
                </div>
            </div>
        </div>

        <!-- 4. Restore -->
        <div id="win-restore" class="window hidden" style="width: 340px; height: 360px;">
            <div class="title-bar" onmousedown="startDrag(event, 'win-restore')">
                <div class="title-text">ç£ç›˜ç¢ç‰‡æ•´ç†ç¨‹åº</div><div class="win-btn" onclick="closeWindow('restore')">X</div>
            </div>
            <div class="window-body" style="background:#c0c0c0; padding:10px; display:flex; flex-direction:column; align-items:center;">
                <div style="margin-bottom:10px; font-size:12px;">æ•°æ®æŸåã€‚è¯·æŒ‰ä½é¼ æ ‡å·¦é”®æ“¦é™¤åé“åŒºåŸŸã€‚</div>
                <div style="position:relative; width:200px; height:200px; border:2px inset #fff; background:#000;">
                    <div id="restore-target" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#fff;"></div>
                    <canvas id="restore-canvas" width="200" height="200" style="position:absolute; top:0; left:0; cursor:crosshair;"></canvas>
                </div>
                <div style="width:200px; height:20px; border:1px solid #888; background:#fff; margin-top:10px; position:relative;">
                    <div id="restore-bar" style="width:0%; height:100%; background:#000080;"></div>
                    <div style="position:absolute; top:0; width:100%; text-align:center; color:#fff; mix-blend-mode:difference; line-height:20px;">æ¢å¤è¿›åº¦</div>
                </div>
            </div>
        </div>

        <!-- 5. Sketchpad -->
        <div id="win-sketchpad" class="window hidden" style="width: 320px; height: 320px;">
            <div class="title-bar" onmousedown="startDrag(event, 'win-sketchpad')">
                <div class="title-text">å‡ ä½•ç”»æ¿ v4.0</div><div class="win-btn" onclick="closeWindow('sketchpad')">X</div>
            </div>
            <div class="menu-bar"><div class="menu-item">æ–‡ä»¶</div><div class="menu-item">ç»˜å›¾</div><div class="menu-item">æ„é€ </div></div>
            <div class="window-body" style="background:#fff; padding:5px;">
                <canvas id="gsp-canvas" width="300" height="260" style="border:1px solid #ccc; cursor:crosshair;"></canvas>
            </div>
        </div>

        <!-- 6. TTPlayer -->
        <div id="win-ttplayer" class="window hidden" style="width: 260px; height: 180px;">
            <div class="title-bar" onmousedown="startDrag(event, 'win-ttplayer')">
                <div class="title-text">åƒåƒé™å¬</div><div class="win-btn" onclick="closeWindow('ttplayer')">X</div>
            </div>
            <div class="window-body" style="background:#2b2b2b; color:#18e018; padding:10px; font-family:'Courier New';">
                <div style="border:1px inset #444; height:24px; line-height:24px; padding:0 5px; overflow:hidden; background:#000; font-size:12px;">
                    <marquee id="music-title" scrollamount="2">â™ª åˆ€éƒ - 2002å¹´çš„ç¬¬ä¸€åœºé›ª.mp3 â™ª</marquee>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:10px;">
                    <div style="font-size:10px;">02:14 / 04:32</div><div style="font-size:10px;">128kbps</div>
                </div>
                <div style="margin-top:10px; display:flex; justify-content:center; gap:10px;">
                    <button style="width:30px; background:#444; color:#fff; border:1px solid #666;" onclick="prevSong()">|&lt;</button>
                    <button id="btn-play" style="width:30px; background:#444; color:#fff; border:1px solid #666;" onclick="toggleMusic()">||</button>
                    <button style="width:30px; background:#444; color:#fff; border:1px solid #666;" onclick="nextSong()">&gt;|</button>
                </div>
                <div style="font-size:10px; color:#888; margin-top:5px; text-align:center;">Playlist: [<span id="playlist-index">1</span>/3]</div>
                <!-- EQ -->
                <div style="display:flex; gap:2px; height:30px; margin-top:5px; align-items:flex-end; justify-content:center;">
                    <div class="bar" style="width:4px; height:10px; background:#18e018; animation:eq 0.5s infinite;"></div>
                    <div class="bar" style="width:4px; height:20px; background:#18e018; animation:eq 0.3s infinite;"></div>
                    <div class="bar" style="width:4px; height:15px; background:#18e018; animation:eq 0.7s infinite;"></div>
                    <div class="bar" style="width:4px; height:25px; background:#18e018; animation:eq 0.4s infinite;"></div>
                    <div class="bar" style="width:4px; height:12px; background:#18e018; animation:eq 0.6s infinite;"></div>
                </div>
            </div>
        </div>
        <style>@keyframes eq { 0%,100% {height:10px} 50% {height:25px} }</style>

        <!-- 7. Recycle -->
        <div id="win-recycle" class="window hidden" style="width: 300px; height: 250px;">
            <div class="title-bar" onmousedown="startDrag(event, 'win-recycle')">
                <div class="title-text">å›æ”¶ç«™</div><div class="win-btn" onclick="closeWindow('recycle')">X</div>
            </div>
            <div class="menu-bar"><div class="menu-item">æ–‡ä»¶</div><div class="menu-item">ç¼–è¾‘</div><div class="menu-item">æŸ¥çœ‹</div></div>
            <div class="window-body">
                <div class="explorer-view" style="display:flex; justify-content:center; align-items:center; color:#888;">(ç©º)</div>
            </div>
            <div style="border-top:1px solid #808080; padding:2px; color:#555; background:#c0c0c0;">0 ä¸ªå¯¹è±¡</div>
        </div>

        <!-- 8. Ciba -->
        <div id="win-ciba" class="window hidden" style="width: 280px; height: 320px;">
            <div class="title-bar" onmousedown="startDrag(event, 'win-ciba')">
                <div class="title-text">é‡‘å±±è¯éœ¸ 2002</div><div class="win-btn" onclick="closeWindow('ciba')">X</div>
            </div>
            <div class="window-body" style="background:#eef; padding:5px; font-family:'SimSun';">
                <div style="border:1px solid #789; background:white; padding:2px; margin-bottom:5px; display:flex;">
                    <span style="margin-right:5px">è¾“å…¥:</span><input type="text" value="Christmas" style="flex-grow:1; border:none; outline:none;" readonly><button style="border:1px solid #808080;">Go</button>
                </div>
                <div style="border:1px solid #789; background:white; flex-grow:1; padding:5px; overflow-y:auto;">
                    <b>Christmas</b> [ËˆkrÉªsmÉ™s]<br><span style="color:#000080">n. åœ£è¯èŠ‚</span><br><br><i>ä¾‹å¥ï¼š</i><br>It's snowing in 2002.<br>2002å¹´çš„é›ªï¼Œä¸‹å¾—å¥½å®‰é™ã€‚<br>
                </div>
            </div>
        </div>

        <!-- 9. Solitaire -->
        <div id="win-solitaire" class="window hidden" style="width: 400px; height: 300px;">
            <div class="title-bar" onmousedown="startDrag(event, 'win-solitaire')">
                <div class="title-text">èœ˜è››çº¸ç‰Œ</div><div class="win-btn" onclick="closeWindow('solitaire')">X</div>
            </div>
            <div class="window-body" style="background:#006000; padding:10px; display:flex; flex-direction:column;">
                <div style="color:white; font-size:12px; margin-bottom:5px;">å¾—åˆ†: <span id="solitaire-score">100</span> æ­¥æ•°: 0</div>
                <div id="solitaire-table" class="card-table" onclick="moveCards()"></div>
            </div>
        </div>

        <!-- Taskbar -->
        <div id="taskbar">
            <div class="start-btn" onclick="alert('Start Menu Error: 0x0000000F')">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path d='M1 1h14v14H1z' fill='black'/><path d='M2 2h5v5H2zM8 2h5v5H8zM2 8h5v5H2zM8 8h5v5H8z' fill='%2300ff00'/></svg>" width="14" style="margin-right:4px;">å¼€å§‹
            </div>
            <div style="border-left:1px solid #808080; border-right:1px solid #fff; height:20px; margin:0 5px;"></div>
            <div class="tray">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path d='M4 4h8v8H4z' fill='none' stroke='black'/><path d='M10 8l-2 2-2-2' stroke='black'/></svg>" width="12"><span id="clock">23:55</span>
            </div>
        </div>
    </div>

    <div id="transfer-modal" class="modal-overlay hidden">
        <div class="msg-box">
            <div class="title-bar"><div class="title-text">æ­£åœ¨å‘é€...</div></div>
            <div style="padding:15px; font-family:'SimSun'; font-size:12px;">
                <div style="margin-bottom:5px;">æ­£åœ¨å‘é€ 'Christmas_Apple.zip' åˆ° 192.168.0.101</div>
                <div style="margin-bottom:10px;">å‰©ä½™æ—¶é—´: <span id="transfer-time">...</span></div>
                <div style="width:100%; height:16px; background:#fff; border:1px solid #888; position:relative;">
                    <div id="transfer-bar" style="width:0%; height:100%; background:#000080;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="ending" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:20000; color:white; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
        <h1 style="color:red; text-shadow:0 0 10px red; margin-bottom:20px;">MERRY CHRISTMAS</h1>
        <div style="font-family:'Courier New'; color:#0f0; line-height:1.6; font-size:14px;">
            <p>> File transmitted successfully.</p><p>> Timeline synchronized.</p><p>> Closing connection...</p>
        </div>
        <br><br>
        <p style="font-family:'SimSun'; font-size:16px; color:#ccc; max-width:500px; padding:20px; border:1px dashed #444;">
            "è°¢è°¢ä½ ï¼Œä¼¼æ°´æµå¹´ã€‚<br>åœ¨è¿™ä¸ªæ—¶ç©ºçš„2002å¹´ï¼Œé›ªåœäº†ã€‚<br>æˆ‘ä¹Ÿæ”¶åˆ°äº†è¿™é¢—è‹¹æœã€‚<br>å†è§ï¼Œæœªæ¥çš„æœ‹å‹ã€‚"
        </p>
    </div>

    <script>
        // ã€å·¥ç¨‹ä¿®æ­£ã€‘ï¼šä¸ºäº†é˜²æ­¢ä½ åœ¨ Github ä¸Šæ³„éœ² Keyï¼Œå»ºè®®ä¿ç•™ä¸ºç©ºã€‚
        // ä»£ç ä¼šè‡ªåŠ¨æ£€æµ‹ï¼Œå¦‚æœä¸ºç©ºåˆ™åˆ‡æ¢åˆ°â€œæœ¬åœ°è„šæœ¬æ¨¡å¼â€ï¼Œä¿è¯æ¸¸æˆæµç¨‹æ­£å¸¸è¿›è¡Œã€‚
        const apiKey = ""; 
        
        const state = {
            booted: false, audioCtx: null, dragItem: null, dragOffset: {x:0, y:0}, zIndex: 100,
            inventory: { apple: false, paper: false, ribbon: false },
            isGiftAssembled: false, isGiftSent: false,
            currentRestoreFile: null, isRestoring: false,
            chatHistory: [],
            // éŸ³é¢‘ä¸¥æ ¼æ§åˆ¶
            bgmPlaying: false,
            currentSongIndex: 0,
            noteTimeout: null
        };

        const filesData = {
            'file_apple': { name: 'IMG_0083.BMP (æŸå)', itemKey: 'apple', itemName: 'çº¢å¯Œå£«è‹¹æœ', svg: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="#c00" stroke="#400" stroke-width="2"/><path d="M50 10 L50 25" stroke="brown" stroke-width="4"/><path d="M50 25 Q70 15 60 40" fill="green"/></svg>` },
            'file_paper': { name: 'WRAPPER.JPG (æ— æ³•è¯»å–)', itemKey: 'paper', itemName: 'å½©è‰²ç»ç’ƒçº¸', svg: `<svg viewBox="0 0 100 100"><rect x="10" y="10" width="80" height="80" fill="rgba(0,255,255,0.3)" stroke="blue"/><circle cx="50" cy="50" r="30" fill="rgba(255,0,255,0.3)"/></svg>` },
            'file_ribbon': { name: 'RIBBON.GIF (é”™è¯¯)', itemKey: 'ribbon', itemName: 'é‡‘è‰²æ‹‰èŠ±', svg: `<svg viewBox="0 0 100 100"><path d="M20 80 Q50 20 80 80" fill="none" stroke="gold" stroke-width="10"/><path d="M20 50 Q50 80 80 50" fill="none" stroke="goldenrod" stroke-width="5"/></svg>` }
        };

        // æ›²åº“
        const playlist = [
            { title: "â™ª åˆ€éƒ - 2002å¹´çš„ç¬¬ä¸€åœºé›ª â™ª", notes: [{f:329.6,d:0.5},{f:392.0,d:0.5},{f:440.0,d:0.5},{f:523.3,d:1.0},{f:440.0,d:0.5},{f:392.0,d:0.5},{f:329.6,d:1.5},{f:293.7,d:0.5},{f:329.6,d:0.5},{f:261.6,d:2.0}] },
            { title: "â™ª å‘¨æ°ä¼¦ - å®‰é™ (Piano) â™ª", notes: [{f:261.6,d:0.4},{f:329.6,d:0.4},{f:392.0,d:0.4},{f:329.6,d:0.4},{f:293.7,d:0.4},{f:349.2,d:0.4},{f:440.0,d:0.4},{f:349.2,d:0.4},{f:261.6,d:0.4},{f:329.6,d:0.4},{f:392.0,d:0.4},{f:329.6,d:0.4},{f:246.9,d:1.0}] },
            { title: "â™ª ä¸­å²›ç¾å˜‰ - é›ªä¹‹èŠ± (Box) â™ª", notes: [{f:329.6,d:0.5},{f:392.0,d:0.5},{f:440.0,d:0.5},{f:392.0,d:0.5},{f:329.6,d:0.5},{f:293.7,d:0.5},{f:261.6,d:1.0},{f:293.7,d:0.5},{f:329.6,d:0.5},{f:392.0,d:1.0},{f:329.6,d:2.0}] }
        ];

        function bootToDisclaimer() { document.getElementById('boot-layer').style.display = 'none'; document.getElementById('intro-modal').style.display = 'flex'; }

        function enterDesktop() {
            if(state.booted) return;
            state.booted = true;
            document.getElementById('intro-modal').style.display = 'none';
            document.getElementById('desktop').style.display = 'block';
            try { state.audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){}
            playBootSound();
            playBGM(); // å¯åŠ¨é»˜è®¤éŸ³ä¹
            setInterval(() => { const now=new Date(); document.getElementById('clock').innerText=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`; }, 1000);
            renderFiles();
            requestAnimationFrame(drawSnow);
            requestAnimationFrame(drawGSP);
            initSolitaire();
            setTimeout(() => {
                document.getElementById('chat-input').disabled=false;
                document.getElementById('chat-input').placeholder="è¾“å…¥æ¶ˆæ¯...";
                openWindow('chat');
                addChatMessage('them', 'å¾€äº‹éšé£', 'ä½ ç»ˆäºä¸Šçº¿äº†ã€‚åœ£è¯å¿«ä¹ï¼^_^');
            }, 2000);
        }

        // --- éŸ³é¢‘å¼•æ“ (Strict) ---
        function playBGM() {
            if(!state.audioCtx) return;
            // å¦‚æœå·²ç»è¢«æ ‡è®°ä¸ºæ’­æ”¾ä¸­ï¼Œä¸éœ€é‡å¤å¯åŠ¨ï¼ˆé˜²æ­¢é‡å ï¼‰
            // ä½†å¦‚æœ noteTimeout ä¸ºç©ºï¼ˆè¯´æ˜ä¹‹å‰çš„æ’­æ”¾ç»“æŸæˆ–è¢«æ¸…é™¤ï¼‰ï¼Œåˆ™å…è®¸å¯åŠ¨
            if(state.bgmPlaying && state.noteTimeout) return; 

            state.bgmPlaying = true;
            document.getElementById('btn-play').innerText = "||";
            
            let noteIndex = 0;
            
            const scheduleNote = () => {
                // åŒé‡æ£€æŸ¥ï¼šå¦‚æœç”¨æˆ·æš‚åœäº†ï¼Œç«‹å³åœæ­¢é€’å½’
                if(!state.bgmPlaying) return; 
                
                const song = playlist[state.currentSongIndex];
                if(noteIndex >= song.notes.length) noteIndex = 0;
                
                const note = song.notes[noteIndex];
                const t = state.audioCtx.currentTime;
                const osc = state.audioCtx.createOscillator();
                const gain = state.audioCtx.createGain();
                
                osc.type = 'sine'; osc.frequency.value = note.f;
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.1, t + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.001, t + note.d);
                
                osc.connect(gain); gain.connect(state.audioCtx.destination);
                osc.start(t); osc.stop(t + note.d);
                
                // å…³é”®ä¿®æ­£ï¼šä¿å­˜ timeout ID ä»¥ä¾¿æ¸…é™¤
                state.noteTimeout = setTimeout(scheduleNote, note.d * 1000);
                noteIndex++;
            };
            scheduleNote();
        }

        function toggleMusic() {
            if(state.audioCtx && state.audioCtx.state === 'suspended') state.audioCtx.resume();
            
            if(state.bgmPlaying) {
                // æš‚åœï¼šæ¸…é™¤çŠ¶æ€å’Œå®šæ—¶å™¨
                state.bgmPlaying = false;
                if(state.noteTimeout) { clearTimeout(state.noteTimeout); state.noteTimeout = null; }
                document.getElementById('btn-play').innerText = ">";
            } else {
                // æ’­æ”¾
                playBGM();
            }
        }

        function changeSong(index) {
            // åˆ‡æ­Œæ—¶å…ˆå¼ºåˆ¶åœæ­¢å½“å‰æ’­æ”¾
            state.bgmPlaying = false;
            if(state.noteTimeout) { clearTimeout(state.noteTimeout); state.noteTimeout = null; }
            
            state.currentSongIndex = index;
            document.getElementById('music-title').innerText = playlist[index].title;
            document.getElementById('playlist-index').innerText = index + 1;
            
            // ç¨ä½œå»¶è¿Ÿåè‡ªåŠ¨å¼€å§‹æ–°æ­Œ
            setTimeout(() => {
                playBGM();
            }, 100);
        }
        function nextSong() { changeSong((state.currentSongIndex + 1) % playlist.length); }
        function prevSong() { changeSong((state.currentSongIndex - 1 + playlist.length) % playlist.length); }

        // --- èŠå¤©é€»è¾‘ (é‡æ„ç‰ˆï¼šå¢åŠ é²æ£’æ€§å’Œæœ¬åœ°å›é€€) ---
        async function sendChat() {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if(!txt) return;

            addChatMessage('me', 'ä¼¼æ°´æµå¹´', txt);
            input.value=''; input.disabled=true; input.placeholder="å¯¹æ–¹æ­£åœ¨è¾“å…¥...";
            
            // è®°å½•ç”¨æˆ·æ¶ˆæ¯
            state.chatHistory.push({role:"user", parts:[{text:txt}]});

            // 1. æ£€æŸ¥æ˜¯å¦åˆšåˆšå‘é€äº†ç¤¼ç‰© (è§¦å‘å‰§æƒ…å…³é”®ç‚¹)
            // å¦‚æœç¤¼ç‰©åˆšé€å‡ºï¼Œå¼ºåˆ¶è¿›å…¥ç»“å±€å¼•å¯¼ï¼Œæ— è®ºæ˜¯å¦æœ‰ API
            if(state.isGiftSent && !state.endingTriggered) {
                state.endingTriggered = true; // é˜²æ­¢é‡å¤
                setTimeout(()=>{
                    const reply = "ï¼ï¼ï¼\nä½ ...ä½ çœŸçš„åšäº†è¿™ä¸ªç»™æˆ‘ï¼Ÿ\nè°¢è°¢ä½ ...ä¼¼æ°´æµå¹´ã€‚\næˆ‘æ”¶åˆ°äº†ï¼Œè¿™æ˜¯æˆ‘ä»Šå¹´æ”¶åˆ°çš„å”¯ä¸€çš„ç¤¼ç‰©ã€‚\n[éš¾è¿‡] [å¾®ç¬‘]";
                    addChatMessage('them', 'å¾€äº‹éšé£', reply);
                    state.chatHistory.push({role:"model", parts:[{text:reply}]});
                    setTimeout(endGame, 6000); // 6ç§’åè¿›å…¥ç»“å±€
                }, 1500);
                input.disabled=false; input.placeholder="è¾“å…¥æ¶ˆæ¯..."; input.focus();
                return;
            }

            // 2. å°è¯•è°ƒç”¨ Gemini API
            if(apiKey && apiKey.length > 10) {
                let prompt = "ä½ å«'å¾€äº‹éšé£'ï¼Œ2002å¹´12æœˆ24æ—¥ç½‘å§ä¸Šç½‘çš„å¿§éƒç½‘å‹ã€‚ä½ çš„èŠå¤©å¯¹è±¡æ˜¯ç©¿è¶Šæ¥çš„ç½‘å‹'ä¼¼æ°´æµå¹´'ã€‚ä¸çŸ¥é“æœªæ¥ã€‚è¯´è¯è¦ç®€çŸ­(15å­—å†…)ï¼Œå¸¦2000å¹´ä»£ç½‘ç»œç‰¹è‰²(å¦‚: 886, MM, æ™•)ã€‚ä¸è¦ç”¨æ‹¬å·æè¿°è¡¨æƒ…ï¼Œç”¨å…³é”®è¯ [å¾®ç¬‘] [éš¾è¿‡] [æƒŠè®¶] æ¥è§¦å‘ç³»ç»Ÿè¡¨æƒ…ã€‚";
                
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({contents:state.chatHistory, systemInstruction:{parts:[{text:prompt}]}})
                    });
                    
                    const d = await res.json();
                    
                    // æ£€æŸ¥ API æ˜¯å¦è¿”å›äº†é”™è¯¯ (ä¾‹å¦‚ Key æ— æ•ˆ)
                    if(d.error) {
                        console.warn("API Error:", d.error);
                        throw new Error("API_FAIL"); 
                    }

                    const rep = d.candidates?.[0]?.content?.parts?.[0]?.text;
                    if(rep) {
                        setTimeout(()=>{ 
                            addChatMessage('them','å¾€äº‹éšé£',rep); 
                            state.chatHistory.push({role:"model", parts:[{text:rep}]});
                        }, 1000);
                        input.disabled=false; input.placeholder="è¾“å…¥æ¶ˆæ¯..."; input.focus();
                        return; // API æˆåŠŸï¼Œç›´æ¥è¿”å›
                    }
                } catch(e){ 
                    console.log("åˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼");
                    // å¤±è´¥åˆ™è½å…¥ä¸‹æ–¹çš„æœ¬åœ°é€»è¾‘
                }
            }

            // 3. æœ¬åœ°å…œåº•é€»è¾‘ (Local Fallback Engine)
            // å½“æ²¡æœ‰ API Key æˆ– API å¤±è´¥æ—¶ï¼Œä½¿ç”¨ç®€å•çš„å…³é”®è¯åŒ¹é…ï¼Œä¿è¯æ¸¸æˆå¯ç©æ€§
            setTimeout(() => {
                const fallbackReply = getLocalReply(txt);
                addChatMessage('them', 'å¾€äº‹éšé£', fallbackReply);
                state.chatHistory.push({role:"model", parts:[{text:fallbackReply}]});
                
                input.disabled=false; input.placeholder="è¾“å…¥æ¶ˆæ¯..."; input.focus();
            }, 1000 + Math.random() * 1000);
        }

        // æœ¬åœ°å¯¹è¯åº“ï¼šæå…¶ç²¾ç¡®çš„è§„åˆ™åŒ¹é…
        function getLocalReply(text) {
            const t = text.toLowerCase();
            if(t.includes("ä½ å¥½") || t.includes("åœ¨å—") || t.includes("hi")) return "æ¥äº†ã€‚ä»Šæ™šç½‘é€Ÿå¥½æ…¢... [å¾®ç¬‘]";
            if(t.includes("æ˜¯è°") || t.includes("åå­—")) return "æˆ‘æ˜¯å¾€äº‹éšé£å•Šï¼Œä½ å¿˜äº†ï¼Ÿæ™•...";
            if(t.includes("åœ£è¯") || t.includes("å¿«ä¹")) return "åœ£è¯å¿«ä¹ã€‚è™½ç„¶åªæœ‰æˆ‘ä¸€ä¸ªäººåœ¨ç½‘å§... [éš¾è¿‡]";
            if(t.includes("ç¤¼ç‰©") || t.includes("å¹³å®‰æœ")) return "ç¤¼ç‰©ï¼Ÿåˆ«é€—æˆ‘äº†ï¼Œè°ä¼šç»™æˆ‘é€ç¤¼ç‰©å•Šã€‚";
            if(t.includes("ç©¿è¶Š") || t.includes("æœªæ¥")) return "ä½ åœ¨è¯´ä»€ä¹ˆå‘¢ï¼Ÿç§‘å¹»ç‰‡çœ‹å¤šäº†å§ GGã€‚";
            if(t.includes("é›ª")) return "æ˜¯å•Šï¼Œå¤–é¢é›ªå¥½å¤§ã€‚å¥½å†·ã€‚";
            if(t.includes("æ­Œ") || t.includes("å¬")) return "æˆ‘ä¹Ÿåœ¨å¬æ­Œã€‚åˆ€éƒçš„æ­Œè™½ç„¶åœŸï¼Œä½†æŒºå¸¦åŠ²çš„ã€‚";
            if(t.includes("88") || t.includes("å†è§")) return "886ã€‚";
            
            // é»˜è®¤éšæœºå›å¤
            const defaults = [
                "ç½‘æœ‰ç‚¹å¡...",
                "åˆšåœ¨æ‰“CSï¼Œæ²¡çœ‹åˆ°ã€‚",
                "å”‰ï¼Œå¥½æ— èŠã€‚",
                "ä½ é‚£è¾¹å†·å—ï¼Ÿ",
                "..."
            ];
            return defaults[Math.floor(Math.random() * defaults.length)];
        }

        function handleChatKey(e) { if(e.key==='Enter') sendChat(); }
        function addChatMessage(role, name, text) {
            const box = document.getElementById('chat-box');
            const t = `[${String(new Date().getHours()).padStart(2,'0')}:${String(new Date().getMinutes()).padStart(2,'0')}]`;
            const emojis = {'\\[å¾®ç¬‘\\]':'ğŸ™‚', '\\[éš¾è¿‡\\]':'ğŸ™', '\\[æƒŠè®¶\\]':'ğŸ˜®'}; 
            let h = text; 
            // æ¢è¡Œç¬¦å¤„ç†
            h = h.replace(/\n/g, '<br>');
            for(let k in emojis) h=h.replace(new RegExp(k,'g'), emojis[k]);
            const d = document.createElement('div'); d.className=`chat-msg ${role}`;
            d.innerHTML = role==='sys'?text:`<span class="time">${t}</span> ${name}: ${h}`;
            box.appendChild(d); box.scrollTop=box.scrollHeight;
            if(role==='them') playTone(800,'sine',0.1);
        }

        // ... existing code (openWindow, closeWindow, etc.) ...
        
        // ä¿®æ­£ sendGift é€»è¾‘ï¼Œç¡®ä¿çŠ¶æ€æ­£ç¡®ä¼ é€’
        function sendGift() { 
            if(state.isGiftSent) return; 
            state.isGiftSent=true; 
            document.getElementById('transfer-modal').classList.remove('hidden'); 
            let p=0; 
            const t=setInterval(()=>{ 
                p+=1; 
                document.getElementById('transfer-bar').style.width=p+'%'; 
                document.getElementById('transfer-time').innerText=Math.ceil((100-p)/10)+'s'; 
                if(p>=100){ 
                    clearInterval(t); 
                    document.getElementById('transfer-modal').classList.add('hidden'); 
                    openWindow('chat'); 
                    // è¿™é‡Œä¸ç›´æ¥è§¦å‘ AI å›å¤ï¼Œè€Œæ˜¯å‘é€ç³»ç»Ÿæ¶ˆæ¯ï¼Œè®© sendChat çš„é€»è¾‘å»æ•è·çŠ¶æ€
                    addChatMessage('me','ä¼¼æ°´æµå¹´','[æ–‡ä»¶å‘é€] Christmas_Apple.zip'); 
                    state.chatHistory.push({role:"user", parts:[{text:"[ç³»ç»Ÿ: å¯¹æ–¹å·²æˆåŠŸæ¥æ”¶æ–‡ä»¶ Christmas_Apple.zip]"}]});
                    // æ¨¡æ‹Ÿå¯¹æ–¹æ”¶åˆ°åçš„ååº” (æ‰‹åŠ¨è°ƒç”¨sendChatæµç¨‹)
                    // æ³¨æ„ï¼šè¿™é‡Œçš„ sendChat å·²ç»è¢«ä¸Šé¢çš„é€»è¾‘æ¥ç®¡ï¼Œå› ä¸ºå®ƒæ£€æµ‹ state.isGiftSent
                    setTimeout(() => {
                        // æ— è®ºæœ‰æ— APIï¼Œè¿™é‡Œéƒ½ä¼šè§¦å‘å‰§æƒ…
                        sendChat(); 
                    }, 1000);
                } 
            }, 50); 
        }

        // --- çª—å£ ---
        function openWindow(id) {
            const w=document.getElementById('win-'+id);
            if(w.classList.contains('hidden')) { w.classList.remove('hidden'); w.style.top=(60+Math.random()*40)+'px'; w.style.left=(60+Math.random()*40)+'px'; playTone(600,'sine',0.05); }
            bringToFront(w);
        }
        function closeWindow(id) { document.getElementById('win-'+id).classList.add('hidden'); }
        function bringToFront(el) { state.zIndex++; el.style.zIndex=state.zIndex; document.querySelectorAll('.title-bar').forEach(t=>t.classList.add('inactive')); el.querySelector('.title-bar').classList.remove('inactive'); }
        function startDrag(e,id) { const w=document.getElementById(id); bringToFront(w); state.dragItem=w; const r=w.getBoundingClientRect(); state.dragOffset={x:e.clientX-r.left, y:e.clientY-r.top}; }
        window.addEventListener('mousemove', e=>{ if(state.dragItem){ state.dragItem.style.left=(e.clientX-state.dragOffset.x)+'px'; state.dragItem.style.top=(e.clientY-state.dragOffset.y)+'px'; } if(state.isRestoring) handleScratch(e); });
        window.addEventListener('mouseup', ()=>{ state.dragItem=null; if(state.isRestoring){ state.isRestoring=false; checkScratch(); } });

        // --- ç©æ³• ---
        function renderFiles() {
            const c=document.getElementById('file-list-container'); c.innerHTML='';
            Object.keys(filesData).forEach(k=>{
                if(state.inventory[filesData[k].itemKey]) return;
                const d=document.createElement('div'); d.className='file-icon';
                d.innerHTML=`<div style="width:32px;height:32px;border:1px solid #000;display:flex;align-items:center;justify-content:center;background:#fff;">!</div><span>${filesData[k].name}</span>`;
                d.ondblclick=()=>openRestore(k); c.appendChild(d);
            });
        }
        function openRestore(k) { state.currentRestoreFile=filesData[k]; openWindow('restore'); document.getElementById('restore-target').innerHTML=state.currentRestoreFile.svg; const ctx=document.getElementById('restore-canvas').getContext('2d'); ctx.globalCompositeOperation='source-over'; ctx.fillStyle='#222'; ctx.fillRect(0,0,200,200); document.getElementById('restore-bar').style.width='0%'; document.getElementById('restore-canvas').onmousedown=e=>{state.isRestoring=true; handleScratch(e);}; }
        function handleScratch(e) { const cvs=document.getElementById('restore-canvas'), r=cvs.getBoundingClientRect(); const ctx=cvs.getContext('2d'); ctx.globalCompositeOperation='destination-out'; ctx.beginPath(); ctx.arc(e.clientX-r.left, e.clientY-r.top, 15, 0, Math.PI*2); ctx.fill(); }
        function checkScratch() {
            const ctx=document.getElementById('restore-canvas').getContext('2d'), d=ctx.getImageData(0,0,200,200).data; let c=0;
            for(let i=3;i<d.length;i+=40) if(d[i]<128) c++;
            const p=c/(d.length/40); document.getElementById('restore-bar').style.width=(p*100)+'%';
            if(p>0.8) { const i=state.currentRestoreFile; state.inventory[i.itemKey]=true; playTone(1200,'sine',0.2); closeWindow('restore'); updateMaker(); renderFiles(); openWindow('maker'); }
        }
        function updateMaker() {
            if(state.inventory.apple) document.getElementById('slot-apple').innerHTML=filesData.file_apple.svg;
            if(state.inventory.paper) document.getElementById('slot-paper').innerHTML=filesData.file_paper.svg;
            if(state.inventory.ribbon) document.getElementById('slot-ribbon').innerHTML=filesData.file_ribbon.svg;
            if(Object.values(state.inventory).every(x=>x)) { document.getElementById('btn-assemble').disabled=false; document.getElementById('btn-assemble').innerText="å¼€å§‹åˆæˆå¹³å®‰æœ"; document.getElementById('btn-assemble').style.color="black"; document.getElementById('maker-status').innerHTML="<span style='color:blue'>ç´ æå°±ç»ªã€‚</span>"; }
        }
        function assemble() { const b=document.getElementById('btn-assemble'); b.innerText="åˆæˆä¸­..."; let p=0; const t=setInterval(()=>{ p+=5; b.style.background=`linear-gradient(90deg, #0f0 ${p}%, #e0e0e0 ${p}%)`; if(p>=100){ clearInterval(t); state.isGiftAssembled=true; document.getElementById('maker-slots').classList.add('hidden'); document.getElementById('btn-assemble').classList.add('hidden'); document.getElementById('final-gift-display').classList.remove('hidden'); document.getElementById('btn-send-gift').classList.remove('hidden'); } }, 100); playTone(400,'triangle',0.5); }
        function endGame() { document.getElementById('desktop').style.filter="grayscale(100%) blur(5px)"; setTimeout(()=>{ document.getElementById('desktop').style.display='none'; document.getElementById('ending').classList.remove('hidden'); }, 2000); }

        function playTone(f,t,d) { if(!state.audioCtx) return; const o=state.audioCtx.createOscillator(), g=state.audioCtx.createGain(); o.type=t; o.frequency.value=f; o.connect(g); g.connect(state.audioCtx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.001, state.audioCtx.currentTime+d); o.stop(state.audioCtx.currentTime+d); }
        function playBootSound() { playTone(100,'square',0.1); setTimeout(()=>playTone(200,'square',0.1), 100); }
        
        let gspT=0; function drawGSP() { const c=document.getElementById('gsp-canvas'); if(c){ const x=c.getContext('2d'); x.clearRect(0,0,300,260); x.strokeStyle='blue'; x.beginPath(); x.moveTo(150,0); x.lineTo(150,260); x.moveTo(0,130); x.lineTo(300,130); x.stroke(); x.strokeStyle='red'; x.beginPath(); for(let i=0;i<300;i++){ const y=Math.sin((i+gspT)*0.05)*50+130; i==0?x.moveTo(i,y):x.lineTo(i,y); } x.stroke(); gspT++; } requestAnimationFrame(drawGSP); }
        function drawSnow() { const c=document.getElementById('snow-canvas'); if(c){ const x=c.getContext('2d'); c.width=window.innerWidth; c.height=window.innerHeight; x.fillStyle='rgba(255,255,255,0.7)'; for(let i=0;i<120;i++) x.fillRect(Math.random()*c.width, Math.random()*c.height, 2, 2); } requestAnimationFrame(drawSnow); }
        function initSolitaire() { const t=document.getElementById('solitaire-table'); if(t){ t.innerHTML=''; for(let i=0;i<7;i++){ const c=document.createElement('div'); c.className=`card ${Math.random()>.5?'red':'black'}`; c.style.left=(i*50+20)+'px'; c.style.top='20px'; c.innerHTML=`<div class="card-face">${['A','K','Q','J','10','9'][i%6]}</div>`; t.appendChild(c); } } }
        function moveCards() { document.querySelectorAll('.card').forEach(c=>{ c.style.top=(Math.random()*200)+'px'; c.style.left=(Math.random()*300)+'px'; c.style.zIndex=Math.floor(Math.random()*10); }); document.getElementById('solitaire-score').innerText=Math.floor(Math.random()*500); }
    </script>
</body>
</html>
